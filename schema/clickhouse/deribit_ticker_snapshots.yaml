# JSON Schema (Draft 2020-12) as YAML
# This is the SINGLE SOURCE OF TRUTH for deribit_options.ticker_snapshots
# All Python types, DDL, and documentation are generated from this file.
#
# ADR: 2025-12-03-deribit-options-clickhouse-pipeline

$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "https://gapless-deribit-clickhouse/schema/deribit_options/ticker_snapshots"

title: "Deribit Options Ticker Snapshots"
description: |
  Point-in-time Open Interest and Greeks snapshots.
  CRITICAL: Open Interest cannot be reconstructed from trades.
  Forward-only collection - no historical backfill available.
  Used for GEX calculation and options positioning analysis.

# ClickHouse-specific metadata (custom extension)
x-clickhouse:
  database: deribit_options
  table: ticker_snapshots
  engine: ReplacingMergeTree()
  order_by: [underlying, expiry, strike, option_type, timestamp]
  partition_by: "toYYYYMM(timestamp)"
  settings:
    index_granularity: 8192

type: object

required:
  - instrument_name
  - timestamp
  - open_interest
  - underlying
  - expiry
  - strike
  - option_type

properties:
  instrument_name:
    type: string
    description: "Full instrument name (e.g., BTC-27DEC24-100000-C)"
    x-clickhouse:
      type: "String"
      not_null: true
    x-pandas:
      dtype: "str"

  timestamp:
    type: string
    format: date-time
    description: "Snapshot timestamp with millisecond precision"
    x-clickhouse:
      type: "DateTime64(3)"
      not_null: true
    x-pandas:
      dtype: "datetime64[ns, UTC]"

  open_interest:
    type: number
    minimum: 0
    description: "Current open interest in contracts"
    x-clickhouse:
      type: "Float64"
      not_null: true
    x-pandas:
      dtype: "float64"
    x-critical: "Cannot be reconstructed from trade data"

  delta:
    type: ["number", "null"]
    description: "Option delta (-1 to 1)"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  gamma:
    type: ["number", "null"]
    minimum: 0
    description: "Option gamma"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  vega:
    type: ["number", "null"]
    description: "Option vega"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  theta:
    type: ["number", "null"]
    description: "Option theta (typically negative)"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  mark_iv:
    type: ["number", "null"]
    minimum: 0
    description: "Mark implied volatility"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  mark_price:
    type: ["number", "null"]
    minimum: 0
    description: "Mark price in USD"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  index_price:
    type: ["number", "null"]
    minimum: 0
    description: "Underlying index price at snapshot time"
    x-clickhouse:
      type: "Nullable(Float64)"
    x-pandas:
      dtype: "Float64"

  # Derived fields (parsed from instrument_name)
  underlying:
    type: string
    enum: ["BTC", "ETH"]
    description: "Underlying asset (derived from instrument_name)"
    x-clickhouse:
      type: "String"
      not_null: true
    x-pandas:
      dtype: "str"
    x-derived: true

  expiry:
    type: string
    format: date
    description: "Option expiration date (derived from instrument_name)"
    x-clickhouse:
      type: "Date"
      not_null: true
    x-pandas:
      dtype: "datetime64[ns]"
    x-derived: true

  strike:
    type: number
    minimum: 0
    description: "Strike price (derived from instrument_name)"
    x-clickhouse:
      type: "Float64"
      not_null: true
    x-pandas:
      dtype: "float64"
    x-derived: true

  option_type:
    type: string
    enum: ["C", "P"]
    description: "Option type: Call (C) or Put (P) (derived from instrument_name)"
    x-clickhouse:
      type: "String"
      not_null: true
    x-pandas:
      dtype: "str"
    x-derived: true
