# ADR: 2025-12-08-clickhouse-naming-convention
min_version = "2024.9.5"

[env]
# Automatic venv activation - mise will use uv to create it
_.python.venv = { path = ".venv", create = true }
# Load ClickHouse credentials from .env (SSoT)
_.file = '.env'

# Schema-first configuration (SSoT)
CLICKHOUSE_DATABASE = "deribit"
CLICKHOUSE_TABLE = "options_trades"

# ClickHouse Cloud Region (for AWS resource deployment)
# ADR: 2025-12-08-clickhouse-data-pipeline-architecture
CLICKHOUSE_CLOUD_REGION = "us-west-2"
AWS_DEFAULT_REGION = "us-west-2"

# Dual-mode: "local" for development/backtesting, "cloud" for production
CLICKHOUSE_MODE = "cloud"

# Local ClickHouse (when CLICKHOUSE_MODE=local)
# Note: clickhouse-connect uses HTTP interface (port 8123, not native 9000)
CLICKHOUSE_LOCAL_HOST = "localhost"
CLICKHOUSE_LOCAL_PORT = "8123"

# ClickHouse Server Configuration (local development)
# ADR: 2025-12-08-mise-pagination-validation
CLICKHOUSE_DATA_DIR = "{{config_root}}/tmp/clickhouse/data"
CLICKHOUSE_LOG_DIR = "{{config_root}}/tmp/clickhouse/logs"
CLICKHOUSE_PID_FILE = "{{config_root}}/tmp/clickhouse/clickhouse.pid"

# Pagination Validation Settings
PAGINATION_GAP_THRESHOLD_MS = "1000"
PAGINATION_LOG_WARNINGS = "true"

[tools]
# Flexible Python: accept any 3.11+ (matches pyproject.toml requires-python)
python = "3"
uv = "latest"
clickhouse = "latest"  # Replaces Homebrew - version-managed
node = "latest"        # For semantic-release

[tasks.install]
description = "Install dependencies with uv"
alias = "i"
run = "uv sync --all-extras"

[tasks.venv-recreate]
description = "Recreate virtual environment from scratch"
run = """
rm -rf .venv
uv venv .venv
uv sync --all-extras
"""

[tasks.test]
description = "Run all tests"
run = "uv run pytest tests/ -v"

[tasks.test-unit]
description = "Run unit tests only (no credentials)"
depends = ["lint"]
run = "uv run pytest tests/ -v -m 'not slow and not e2e'"

[tasks.test-e2e]
description = "Run E2E tests (requires credentials)"
run = "uv run pytest tests/e2e/ -v -m e2e"

[tasks.test-contracts]
description = "Run contract tests"
run = "uv run pytest tests/contracts/ -v"

[tasks.lint]
description = "Run ruff linting"
run = "uv run ruff check src/"

[tasks.format]
description = "Format code"
run = "uv run ruff format src/ tests/"

[tasks.schema-validate]
description = "Validate YAML schema vs live ClickHouse"
run = "uv run python -m gapless_deribit_clickhouse.schema.cli validate"

[tasks.schema-diff]
description = "Show schema drift between YAML and live"
run = "uv run python -m gapless_deribit_clickhouse.schema.cli diff"

[tasks.security]
description = "Run security scans (semgrep + gitleaks)"
run = """
semgrep scan --config auto src/ && gitleaks detect --source .
"""

[tasks.ci]
description = "Full CI pipeline (lint + tests + security)"
depends = ["lint", "test-unit", "test-contracts", "security"]
run = "echo '✓ CI pipeline passed'"

# Hidden helper tasks (internal utilities)
# ADR: 2025-12-08-clickhouse-naming-convention

[tasks._check-credentials]
description = "Verify ClickHouse credentials are set"
hide = true
run = """
if [ -z "$CLICKHOUSE_HOST_READONLY" ]; then
  echo "❌ CLICKHOUSE_HOST_READONLY not set. Copy .env.example to .env"
  exit 1
fi
echo "✓ Credentials configured"
"""

[tasks._confirm-destructive]
description = "Confirm destructive operation"
hide = true
run = """
echo "⚠️  This will DROP existing data. Press Enter to continue or Ctrl+C to cancel..."
read
"""

# Database management tasks with depends_post for automatic validation

[tasks.db-init]
description = "Create ClickHouse database and table from schema"
depends = ["_check-credentials"]
depends_post = ["schema-validate"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli init"

[tasks.db-drop]
description = "Drop legacy database (destructive!)"
depends = ["_check-credentials", "_confirm-destructive"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli drop-legacy"

[tasks.db-migrate]
description = "Full migration: drop legacy + create new + validate"
depends = ["db-drop", "db-init"]
depends_post = ["test-e2e"]
run = "echo '✓ Migration complete'"

# =============================================================================
# Dual-Mode Orchestration Tasks
# ADR: 2025-12-08-clickhouse-data-pipeline-architecture
# =============================================================================

[tasks._check-local-server]
description = "Verify local ClickHouse is running"
hide = true
run = """
curl -s http://localhost:8123/ping > /dev/null 2>&1 || {
  echo "❌ Local ClickHouse not running. Start with: clickhouse server"
  exit 1
}
echo "✓ Local ClickHouse running"
"""

[tasks.local-init]
description = "Initialize local ClickHouse with same schema as cloud"
env = { CLICKHOUSE_MODE = "local" }
depends = ["_check-local-server"]
depends_post = ["local-validate"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli init"

[tasks.local-validate]
description = "Validate local schema matches YAML"
env = { CLICKHOUSE_MODE = "local" }
run = "uv run python -m gapless_deribit_clickhouse.schema.cli validate"

[tasks.cloud-validate]
description = "Validate cloud schema matches YAML"
env = { CLICKHOUSE_MODE = "cloud" }
depends = ["_check-credentials"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli validate"

[tasks.schema-align]
description = "Verify local and cloud schemas are aligned"
depends = ["local-validate", "cloud-validate"]
run = "echo '✓ Local and cloud schemas aligned with YAML SSoT'"

[tasks.e2e-validate]
description = "E2E validation: collect real Deribit data to local ClickHouse"
env = { CLICKHOUSE_MODE = "local" }
depends = ["local-init", "_check-local-server"]
run = """
uv run python -c "
from gapless_deribit_clickhouse import collect_trades
from gapless_deribit_clickhouse.clickhouse.connection import get_client
import os

os.environ['CLICKHOUSE_MODE'] = 'local'

print('Step 1: Collecting real data from Deribit API (1 hour window)...')
df = collect_trades(
    currency='BTC',
    start_date='2024-12-01',
    end_date='2024-12-01 01:00:00',
    insert_to_db=True
)
print(f'Collected and inserted {len(df)} real trades')

print('Step 2: Verifying inserted data...')
client = get_client(mode='local')
count = client.command('SELECT count() FROM deribit.options_trades')
assert count > 0, f'Expected trades, got {count}'
print(f'Local ClickHouse has {count} rows')

print('E2E validation PASSED')
"
"""

[tasks.measure-volume]
description = "Measure actual Deribit data volume for 1 day"
run = """
uv run python -c "
from gapless_deribit_clickhouse import collect_trades

print('Measuring real Deribit data volume (1 day)...')
df = collect_trades(
    currency='BTC',
    start_date='2024-12-01',
    end_date='2024-12-02',
    insert_to_db=False
)

rows = len(df)
bytes_raw = df.memory_usage(deep=True).sum()
print(f'Rows per day: {rows:,}')
print(f'Bytes per day (raw): {bytes_raw:,}')
print(f'Bytes per row: {bytes_raw // rows if rows else 0}')
print(f'Estimated monthly: {rows * 30:,} rows, {bytes_raw * 30 / 1e9:.2f} GB')
print(f'Estimated full backfill (84 months): {rows * 30 * 84:,} rows')
"
"""

[tasks.measure-baseline]
description = "Record baseline costs from billing APIs"
run = "uv run scripts/measure_baseline_costs.py"

[tasks.monitor-egress]
description = "Check egress costs against threshold"
run = "uv run scripts/monitor_egress.py"

# =============================================================================
# ClickHouse Server Management Tasks
# ADR: 2025-12-08-mise-pagination-validation
# =============================================================================

[tasks._ch-dirs]
description = "Create ClickHouse data directories"
hide = true
run = 'mkdir -p "$CLICKHOUSE_DATA_DIR" "$CLICKHOUSE_LOG_DIR"'

[tasks.ch-start]
description = "Start local ClickHouse server"
depends = ["_ch-dirs"]
run = """
if [ -f "$CLICKHOUSE_PID_FILE" ] && kill -0 $(cat "$CLICKHOUSE_PID_FILE") 2>/dev/null; then
  echo "✓ ClickHouse already running (PID $(cat $CLICKHOUSE_PID_FILE))"
else
  clickhouse server --daemon \
    --pid-file="$CLICKHOUSE_PID_FILE" \
    --path="$CLICKHOUSE_DATA_DIR" \
    -- --logger.log="$CLICKHOUSE_LOG_DIR/clickhouse-server.log" \
       --logger.errorlog="$CLICKHOUSE_LOG_DIR/clickhouse-server.err.log"
  sleep 2
  curl -s http://localhost:8123/ping && echo "✓ ClickHouse started"
fi
"""

[tasks.ch-stop]
description = "Stop local ClickHouse server"
run = """
if [ -f "$CLICKHOUSE_PID_FILE" ]; then
  kill $(cat "$CLICKHOUSE_PID_FILE") 2>/dev/null && echo "✓ ClickHouse stopped"
  rm -f "$CLICKHOUSE_PID_FILE"
else
  echo "ClickHouse not running"
fi
"""

[tasks.ch-status]
description = "Check ClickHouse server status"
run = 'curl -s http://localhost:8123/ping && echo "✓ ClickHouse running" || echo "❌ ClickHouse not running"'

[tasks.ch-logs]
description = "Tail ClickHouse server logs"
run = "tail -f $CLICKHOUSE_LOG_DIR/clickhouse-server.log"

# =============================================================================
# Quality Tasks
# ADR: 2025-12-08-mise-pagination-validation
# =============================================================================

[tasks.type-check]
description = "Run mypy type checking"
run = "uv run mypy src/"

[tasks.lint-all]
description = "Run all linting (ruff + mypy)"
depends = ["lint", "type-check"]
run = "echo '✓ All linting passed'"

[tasks.pre-release]
description = "Pre-release validation (lint + tests + security)"
depends = ["lint-all", "test-unit", "test-contracts", "security"]
run = "echo '✓ Ready for release'"

[tasks.dev]
description = "Start development environment"
depends = ["ch-start", "local-init"]
run = "echo '✓ Development environment ready'"
