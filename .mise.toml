# ADR: 2025-12-08-clickhouse-naming-convention
min_version = "2024.9.5"

[env]
# Automatic venv activation - mise will use uv to create it
_.python.venv = { path = ".venv", create = true }
# Load ClickHouse credentials from .env (SSoT)
_.file = '.env'

# Schema-first configuration (SSoT)
CLICKHOUSE_DATABASE = "deribit"
CLICKHOUSE_TABLE = "options_trades"

[tools]
# Flexible Python: accept any 3.11+ (matches pyproject.toml requires-python)
python = "3"
uv = "latest"

[tasks.install]
description = "Install dependencies with uv"
alias = "i"
run = "uv sync --all-extras"

[tasks.venv-recreate]
description = "Recreate virtual environment from scratch"
run = """
rm -rf .venv
uv venv .venv
uv sync --all-extras
"""

[tasks.test]
description = "Run all tests"
run = "uv run pytest tests/ -v"

[tasks.test-unit]
description = "Run unit tests only (no credentials)"
depends = ["lint"]
run = "uv run pytest tests/ -v -m 'not slow and not e2e'"

[tasks.test-e2e]
description = "Run E2E tests (requires credentials)"
run = "uv run pytest tests/e2e/ -v -m e2e"

[tasks.test-contracts]
description = "Run contract tests"
run = "uv run pytest tests/contracts/ -v"

[tasks.lint]
description = "Run ruff linting"
run = "uv run ruff check src/"

[tasks.format]
description = "Format code"
run = "uv run ruff format src/ tests/"

[tasks.schema-validate]
description = "Validate YAML schema vs live ClickHouse"
run = "uv run python -m gapless_deribit_clickhouse.schema.cli validate"

[tasks.schema-diff]
description = "Show schema drift between YAML and live"
run = "uv run python -m gapless_deribit_clickhouse.schema.cli diff"

[tasks.security]
description = "Run security scans (semgrep + gitleaks)"
run = """
semgrep scan --config auto src/ && gitleaks detect --source .
"""

[tasks.ci]
description = "Full CI pipeline (lint + tests + security)"
depends = ["lint", "test-unit", "test-contracts", "security"]
run = "echo '✓ CI pipeline passed'"

# Hidden helper tasks (internal utilities)
# ADR: 2025-12-08-clickhouse-naming-convention

[tasks._check-credentials]
description = "Verify ClickHouse credentials are set"
hide = true
run = """
if [ -z "$CLICKHOUSE_HOST_READONLY" ]; then
  echo "❌ CLICKHOUSE_HOST_READONLY not set. Copy .env.example to .env"
  exit 1
fi
echo "✓ Credentials configured"
"""

[tasks._confirm-destructive]
description = "Confirm destructive operation"
hide = true
run = """
echo "⚠️  This will DROP existing data. Press Enter to continue or Ctrl+C to cancel..."
read
"""

# Database management tasks with depends_post for automatic validation

[tasks.db-init]
description = "Create ClickHouse database and table from schema"
depends = ["_check-credentials"]
depends_post = ["schema-validate"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli init"

[tasks.db-drop]
description = "Drop legacy database (destructive!)"
depends = ["_check-credentials", "_confirm-destructive"]
run = "uv run python -m gapless_deribit_clickhouse.schema.cli drop-legacy"

[tasks.db-migrate]
description = "Full migration: drop legacy + create new + validate"
depends = ["db-drop", "db-init"]
depends_post = ["test-e2e"]
run = "echo '✓ Migration complete'"
